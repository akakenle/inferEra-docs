---
title: "ç¬¬ä¸‰æ–¹æ‡‰ç”¨æ¥å…¥æŒ‡å—"
description: " "
icon: "webhook"
---

## é‡è¦å®‰å…¨è²æ˜

å®‰å…¨ç¬¬ä¸€åŸå‰‡ï¼šåœ¨é–‹ç™¼å’Œéƒ¨ç½²ç¬¬ä¸‰æ–¹æ‡‰ç”¨æ™‚ï¼Œå®‰å…¨æ€§æ˜¯æœ€é‡è¦çš„è€ƒæ…®å› ç´ ã€‚å¿…é ˆåš´æ ¼éµå®ˆä»¥ä¸‹å®‰å…¨åŸå‰‡ï¼Œç¢ºä¿ç”¨æˆ¶è³‡æ–™å’Œæˆæ¬Šæµç¨‹çš„å®‰å…¨æ€§ã€‚

<Warning>
1. çµ•å°ç¦æ­¢åœ¨å‰ç«¯ JavaScript ç¨‹å¼ç¢¼ä¸­æš´éœ² `client_secret`
2. å¿…é ˆåœ¨ä¼ºæœå™¨ç«¯è™•ç† OAuth æˆæ¬Šç¢¼äº¤æ› token çš„éç¨‹
3. å¿…é ˆé€éå¾Œç«¯ API ä»£ç†å­˜å–å—ä¿è­·çš„ç”¨æˆ¶è³‡æº
4. å¿…é ˆä½¿ç”¨ HTTPS å”å®šä¿è­·æ‰€æœ‰ OAuth é€šè¨Š
</Warning>

é•åä»¥ä¸Šä»»ä½•ä¸€æ¢å®‰å…¨åŸå‰‡éƒ½å¯èƒ½å°è‡´åš´é‡çš„å®‰å…¨æ¼æ´ï¼

## ğŸ“‹ ç›®éŒ„

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¥å…¥æº–å‚™](#æ¥å…¥æº–å‚™)
3. [OAuth2 æˆæ¬Šæµç¨‹](#oauth2æˆæ¬Šæµç¨‹)
4. [APIä»‹é¢æ–‡ä»¶](#apiä»‹é¢æ–‡ä»¶)
5. [SDKå’Œç¨‹å¼ç¢¼ç¯„ä¾‹](#sdkå’Œç¨‹å¼ç¢¼ç¯„ä¾‹)
6. [å®‰å…¨æœ€ä½³å¯¦è¸](#å®‰å…¨æœ€ä½³å¯¦è¸)
7. [å¸¸è¦‹å•é¡Œ](#å¸¸è¦‹å•é¡Œ)
8. [æŠ€è¡“æ”¯æ´](#æŠ€è¡“æ”¯æ´)

## æ¦‚è¿°

æˆ‘å€‘æä¾›åŸºæ–¼ OAuth2 æ¨™æº–çš„é–‹æ”¾ APIï¼Œå…è¨±ç¬¬ä¸‰æ–¹æ‡‰ç”¨å®‰å…¨åœ°å­˜å–ç”¨æˆ¶çš„åŸºæœ¬è³‡è¨Šå’Œå¸³æˆ¶é¤˜é¡ã€‚é€éæˆ‘å€‘çš„ OAuth2 æœå‹™ï¼Œæ‚¨çš„æ‡‰ç”¨å¯ä»¥ï¼š

- ğŸš€ ä¸€éµç™»å…¥ï¼šç”¨æˆ¶ç„¡éœ€é‡è¤‡è¨»å†Šï¼Œç™»å…¥å®Œæˆå³è‡ªå‹•æˆæ¬Šï¼ŒçœŸæ­£çš„ç„¡ç¸«é«”é©—
- ğŸ‘¤ å–å¾—ç”¨æˆ¶è³‡è¨Šï¼šå­˜å–ç”¨æˆ¶çš„åŸºæœ¬è³‡æ–™ï¼ˆç”¨æˆ¶åã€é›»å­éƒµä»¶ç­‰ï¼‰
- ğŸ’° æŸ¥çœ‹å¸³æˆ¶é¤˜é¡ï¼šå³æ™‚å–å¾—ç”¨æˆ¶çš„å¸³æˆ¶é¤˜é¡è³‡è¨Š
- ğŸ”„ å„²å€¼è·³è½‰ï¼šå¼•å°ç”¨æˆ¶åˆ°æˆ‘å€‘çš„å„²å€¼é é¢é€²è¡Œå¸³æˆ¶å„²å€¼
- ğŸ” è‡ªå‹•tokenåˆ·æ–°ï¼šå…§å»º refresh token æ©Ÿåˆ¶ï¼Œç„¡æ„Ÿåˆ·æ–°éæœŸ tokenï¼Œæå‡ç”¨æˆ¶é«”é©—

## æ¥å…¥æº–å‚™

### 1. è¨»å†Šé–‹ç™¼è€…å¸³æˆ¶

é¦–å…ˆï¼Œæ‚¨éœ€è¦åœ¨æˆ‘å€‘çš„ç³»çµ±ä¸­è¨»å†Šä¸€å€‹é–‹ç™¼è€…å¸³æˆ¶ã€‚

### 2. å»ºç«‹ OAuth æ‡‰ç”¨

åœ¨é–‹ç™¼è€…æ§åˆ¶å°ä¸­å»ºç«‹æ‚¨çš„ OAuth æ‡‰ç”¨ï¼š

```shell API å‘¼å«ç¯„ä¾‹
curl -X POST https://api.aihubmix.com/api/oauth_apps \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_DEVELOPER_TOKEN" \
  -d '{
    "name": "æˆ‘çš„ç¬¬ä¸‰æ–¹æ‡‰ç”¨",
    "description": "æ‡‰ç”¨æè¿°è³‡è¨Š",
    "redirect_uri": "https://yourapp.com/oauth/callback"
  }'
```

å›æ‡‰ç¯„ä¾‹ï¼š

```json
{
  "success": true,
  "message": "æ‡‰ç”¨å»ºç«‹æˆåŠŸ",
  "data": {
    "id": 1,
    "name": "æˆ‘çš„ç¬¬ä¸‰æ–¹æ‡‰ç”¨",
    "client_id": "client_abc123def456...",
    "client_secret": "secret_xyz789uvw012...",
    "redirect_uri": "https://yourapp.com/oauth/callback",
    "created_time": 1640995200
  }
}
```

å®‰å…¨é‡è¦æé†’ï¼š
<Warning>
- client_id å¯ä»¥åœ¨å‰ç«¯ä½¿ç”¨ï¼ˆå…¬é–‹è³‡è¨Šï¼‰
- `client_secret` åªèƒ½åœ¨ä¼ºæœå™¨ç«¯ä½¿ç”¨ï¼Œçµ•ä¸èƒ½æš´éœ²çµ¦ç€è¦½å™¨
- è«‹å°‡ client_secret å„²å­˜åœ¨ç’°å¢ƒè®Šæ•¸ä¸­ï¼Œä¸è¦ç¡¬ç·¨ç¢¼åœ¨ç¨‹å¼ç¢¼ä¸­
</Warning>

### 3. é…ç½®å›èª¿åœ°å€

ç¢ºä¿æ‚¨çš„å›èª¿åœ°å€ï¼ˆredirect_uriï¼‰æ»¿è¶³ä»¥ä¸‹è¦æ±‚ï¼š

- ä½¿ç”¨HTTPSå”å®šï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰
- æŒ‡å‘æ‚¨çš„ä¼ºæœå™¨ç«¯é»ï¼ˆè€Œéå‰ç«¯é é¢ï¼‰
- åŸŸåå·²å‚™æ¡ˆä¸”å¯æ­£å¸¸å­˜å–
- è·¯å¾‘å…·é«”åˆ°è™•ç†å›èª¿çš„APIç«¯é»


## OAuth2 æˆæ¬Šæµç¨‹

### å®‰å…¨æµç¨‹åœ–

```mermaid
sequenceDiagram
    participant Browser  as ç”¨æˆ¶ç€è¦½å™¨
    participant Backend  as æ‚¨çš„ä¼ºæœå™¨
    participant OAuthSrv as æˆ‘å€‘çš„ä¼ºæœå™¨

    %% ç™»å…¥å…¥å£
    Browser  ->> Backend : GET /auth<br>(ç”¨æˆ¶é»æ“Šç™»å…¥)

    %% ç”Ÿæˆä¸¦ä¿å­˜ stateï¼Œéš¨å¾Œè·³è½‰
    Backend  ->> Backend : ç”Ÿæˆ state<br>å„²å­˜ state
    Backend  ->> OAuthSrv: é‡å®šå‘åˆ°æˆæ¬Š<br>(å¸¶ client_id)

    %% å±•ç¤ºæˆæ¬Šé ä¸¦å®Œæˆæˆæ¬Š
    OAuthSrv -->> Browser : é¡¯ç¤ºæˆæ¬Šé é¢
    Browser  ->> Browser : ç”¨æˆ¶å®Œæˆæˆæ¬Š

    %% æˆæ¬Šä¼ºæœå™¨é€éç€è¦½å™¨å›èª¿
    Browser  ->> Backend : GET /callback
    Backend  ->> Backend : é©—è­‰ state
    Backend  ->> OAuthSrv: ç”¨æˆæ¬Šç¢¼æ› token<br>(å¸¶ secret)
    OAuthSrv -->> Backend : é©—è­‰ä¸¦è¿”å› token

    %% ä¿å­˜ token ä¸¦å›åˆ°å‰ç«¯
    Backend  ->> Backend : å„²å­˜ token
    Backend  -->> Browser : é‡å®šå‘åˆ°å‰ç«¯

    %% æ‹‰å–ç”¨æˆ¶è³‡è¨Š
    Browser  ->> Browser : é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
    Browser  ->> Backend : GET /api/user
    Backend  ->> OAuthSrv: ç”¨ token è«‹æ±‚ç”¨æˆ¶è³‡è¨Š
    OAuthSrv -->> Backend : è¿”å›ç”¨æˆ¶è³‡è¨Š
    Backend  -->> Browser : è¿”å›ç”¨æˆ¶è³‡è¨Š
```

### è©³ç´°æ­¥é©Ÿ

#### æ­¥é©Ÿ 1ï¼šå¼•å°ç”¨æˆ¶æˆæ¬Š

åœ¨æ‚¨çš„å‰ç«¯é é¢æ·»åŠ ç™»å…¥æŒ‰éˆ•ï¼Œé»æ“Šå¾Œé‡å®šå‘åˆ°æ‚¨çš„ä¼ºæœå™¨ç«¯æˆæ¬Šç«¯é»ï¼š

```js å‰ç«¯ç¨‹å¼ç¢¼ - åªè² è²¬é‡å®šå‘
function startLogin() {
    // é‡å®šå‘åˆ°æ‚¨çš„ä¼ºæœå™¨ç«¯æˆæ¬Šè™•ç†ç«¯é»
    window.location.href = '/auth/oauth/start';
}
```

#### æ­¥é©Ÿ 2ï¼šä¼ºæœå™¨ç«¯è™•ç†æˆæ¬Šè«‹æ±‚

åœ¨æ‚¨çš„ä¼ºæœå™¨ç«¯å¯¦ç¾æˆæ¬Šè™•ç†ï¼š

```js ä¼ºæœå™¨ç«¯ç¨‹å¼ç¢¼
app.get('/auth/oauth/start', (req, res) => {
    // ç”Ÿæˆä¸¦å„²å­˜stateåƒæ•¸
    const state = generateSecureRandomString();
    req.session.oauth_state = state;
    
    // å»ºæ§‹æˆæ¬ŠURL
    const authUrl = new URL('https://your-domain.com/api/oauth2/authorize');
    authUrl.searchParams.append('client_id', process.env.OAUTH_CLIENT_ID);
    authUrl.searchParams.append('redirect_uri', process.env.OAUTH_REDIRECT_URI);
    authUrl.searchParams.append('response_type', 'code');
    authUrl.searchParams.append('scope', 'profile balance');
    authUrl.searchParams.append('state', state);
    authUrl.searchParams.append('auto_authorize', 'true'); // ä¸€éµç™»å…¥
    
    // é‡å®šå‘åˆ°æˆæ¬Šä¼ºæœå™¨
    res.redirect(authUrl.toString());
});
```

#### æ­¥é©Ÿ 3ï¼šè™•ç†æˆæ¬Šå›èª¿ï¼ˆä¼ºæœå™¨ç«¯ï¼‰

```js ä¼ºæœå™¨ç«¯è™•ç†æˆæ¬Šå›èª¿
app.get('/oauth/callback', async (req, res) => {
    const { code, state, error } = req.query;
    
    // éŒ¯èª¤è™•ç†
    if (error) {
        return res.redirect(`/?error=${encodeURIComponent(error)}`);
    }
    
    // åƒæ•¸é©—è­‰
    if (!code || !state) {
        return res.redirect('/?error=missing_parameters');
    }
    
    // é©—è­‰stateåƒæ•¸ï¼ˆé˜²CSRFæ”»æ“Šï¼‰
    if (state !== req.session.oauth_state) {
        return res.redirect('/?error=invalid_state');
    }
    
    try {
        // ç”¨æˆæ¬Šç¢¼æ›å–å­˜å–ä»¤ç‰Œï¼ˆåœ¨ä¼ºæœå™¨ç«¯å®Œæˆï¼‰
        const tokenResponse = await fetch('https://your-domain.com/api/oauth2/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: process.env.OAUTH_REDIRECT_URI,
                client_id: process.env.OAUTH_CLIENT_ID,
                client_secret: process.env.OAUTH_CLIENT_SECRET // åªåœ¨ä¼ºæœå™¨ç«¯ä½¿ç”¨
            })
        });
        
        const tokenData = await tokenResponse.json();
        
        if (!tokenResponse.ok) {
            throw new Error(tokenData.error || 'Token exchange failed');
        }
        
        // å®‰å…¨å„²å­˜tokenï¼ˆä¼ºæœå™¨ç«¯sessionæˆ–è³‡æ–™åº«ï¼‰
        req.session.access_token = tokenData.access_token;
        req.session.refresh_token = tokenData.refresh_token;
        req.session.token_expires_at = Date.now() + (tokenData.expires_in * 1000);
        
        // æ¸…ç†è‡¨æ™‚ç‹€æ…‹
        delete req.session.oauth_state;
        
        // é‡å®šå‘åˆ°å‰ç«¯é é¢
        res.redirect('/?login=success');
        
    } catch (error) {
        console.error('OAuth callback error:', error);
        res.redirect(`/?error=server_error`);
    }
});
```

#### æ­¥é©Ÿ 4ï¼šå‰ç«¯ç²å–ç”¨æˆ¶è³‡è¨Š

```js å‰ç«¯é€é API ä»£ç†ç²å–ç”¨æˆ¶è³‡è¨Š
async function loadUserInfo() {
    try {
        const response = await fetch('/api/user/info');
        
        if (!response.ok) {
            throw new Error('Failed to fetch user info');
        }
        
        const userInfo = await response.json();
        displayUserInfo(userInfo);
        
    } catch (error) {
        console.error('Failed to load user info:', error);
        showLoginButton();
    }
}
```

```js ä¼ºæœå™¨ç«¯APIä»£ç†
app.get('/api/user/info', async (req, res) => {
    const accessToken = req.session.access_token;
    
    if (!accessToken) {
        return res.status(401).json({ error: 'Not authenticated' });
    }
    
    try {
        // ä»£ç†è«‹æ±‚åˆ°OAuthä¼ºæœå™¨
        const response = await fetch('https://your-domain.com/api/oauth2/userinfo', {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });
        
        if (!response.ok) {
            throw new Error('User info request failed');
        }
        
        const userInfo = await response.json();
        res.json(userInfo);
        
    } catch (error) {
        console.error('User info proxy error:', error);
        res.status(500).json({ error: 'Server error' });
    }
});
```

<Tips>
ä¸€éµç™»å…¥é«”é©—ï¼šè¨­å®š `auto_authorize=true` å¾Œï¼Œç”¨æˆ¶åªéœ€è¦å®Œæˆç™»å…¥æ“ä½œï¼Œç³»çµ±æœƒè‡ªå‹•å®Œæˆæˆæ¬Šï¼Œç„¡éœ€é¡å¤–çš„ç¢ºèªæ­¥é©Ÿã€‚
</Tips>

## API ä»‹é¢æ–‡ä»¶

### 1. æˆæ¬Šç«¯é»

GET `/api/oauth2/authorize`

å¼•å°ç”¨æˆ¶é€²è¡Œ OAuth2 æˆæ¬Šã€‚

åƒæ•¸ï¼š
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ |
| --- | --- | --- | --- |
| `client_id` | string | æ˜¯ | æ‡‰ç”¨çš„å®¢æˆ¶ç«¯IDï¼ˆå¯åœ¨å‰ç«¯ä½¿ç”¨ï¼‰ |
| `redirect_uri` | string | æ˜¯ | æˆæ¬Šå¾Œçš„å›èª¿åœ°å€ï¼ˆå¿…é ˆæŒ‡å‘ä¼ºæœå™¨ç«¯é»ï¼‰ |
| `response_type` | string | æ˜¯ | å›ºå®šå€¼ï¼š`code` |
| `scope` | string | å¦ | æ¬Šé™ç¯„åœï¼Œå¤šå€‹ç”¨ç©ºæ ¼åˆ†éš” |
| `state` | string | å¿…å¡« | é˜²CSRFæ”»æ“Šçš„éš¨æ©Ÿå­—ä¸²ï¼ˆä¼ºæœå™¨ç«¯ç”Ÿæˆï¼‰ |
| `auto_authorize` | string | å¦ | è¨­ç‚º `true` æ™‚å•Ÿç”¨è‡ªå‹•æˆæ¬Š |

å®‰å…¨è¦æ±‚ï¼š
- `redirect_uri` å¿…é ˆèˆ‡è¨»å†Šæ™‚çš„åœ°å€å®Œå…¨åŒ¹é…
- `state` åƒæ•¸å¿…é ˆæ˜¯ä¼ºæœå™¨ç«¯ç”Ÿæˆçš„éš¨æ©Ÿå­—ä¸²
- å¿…é ˆä½¿ç”¨ HTTPS å”å®šï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰

Scope èªªæ˜ï¼š
- `profile`ï¼šç²å–ç”¨æˆ¶åŸºæœ¬è³‡è¨Šï¼ˆç”¨æˆ¶åã€é›»å­éƒµä»¶ï¼‰
- `balance`ï¼šç²å–ç”¨æˆ¶å¸³æˆ¶é¤˜é¡è³‡è¨Š

### 2. ä»¤ç‰Œ(Token)ç²å–ç«¯é»

POST `/api/oauth2/token`

<Warning>
å®‰å…¨è­¦å‘Šï¼šæ­¤ç«¯é»åªèƒ½å¾ä¼ºæœå™¨ç«¯å‘¼å«ï¼Œçµ•ä¸èƒ½åœ¨å‰ç«¯ä½¿ç”¨ï¼
</Warning>

ç”¨æ–¼å…©ç¨®å ´æ™¯ï¼š
1. ä½¿ç”¨æˆæ¬Šç¢¼æ›å–å­˜å–ä»¤ç‰Œ
2. ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œç²å–æ–°çš„å­˜å–ä»¤ç‰Œ

æˆæ¬Šç¢¼æ¨¡å¼åƒæ•¸ï¼š
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ |
| --- | --- | --- | --- |
| `grant_type` | string | æ˜¯ | å›ºå®šå€¼ï¼š`authorization_code` |
| `code` | string | æ˜¯ | æˆæ¬Šç¢¼ |
| `redirect_uri` | string | æ˜¯ | å¿…é ˆèˆ‡æˆæ¬Šæ™‚çš„åœ°å€ä¸€è‡´ |
| `client_id` | string | æ˜¯ | æ‡‰ç”¨çš„å®¢æˆ¶ç«¯ ID |
| `client_secret` | string | æ˜¯ | æ‡‰ç”¨çš„å®¢æˆ¶ç«¯å¯†é‘°ï¼ˆåªèƒ½åœ¨ä¼ºæœå™¨ç«¯ä½¿ç”¨ï¼‰ |


åˆ·æ–°ä»¤ç‰Œåƒæ•¸ï¼š
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ |
| --- | --- | --- | --- |
| `grant_type` | string | æ˜¯ | å›ºå®šå€¼ï¼š`refresh_token` |
| `refresh_token` | string | æ˜¯ | åˆ·æ–°ä»¤ç‰Œ |
| `client_id` | string | æ˜¯ | æ‡‰ç”¨çš„å®¢æˆ¶ç«¯ID |
| `client_secret` | string | æ˜¯ | æ‡‰ç”¨çš„å®¢æˆ¶ç«¯å¯†é‘°ï¼ˆåªèƒ½åœ¨ä¼ºæœå™¨ç«¯ä½¿ç”¨ï¼‰ |

å›æ‡‰ç¯„ä¾‹ï¼š
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 7200,
  "refresh_token": "refresh_abc123def456...",
  "scope": "profile balance"
}
```

### 3. ç”¨æˆ¶è³‡è¨Šç«¯é»

GET `/api/oauth2/userinfo`

ç²å–ç”¨æˆ¶åŸºæœ¬è³‡è¨Šå’Œå¸³æˆ¶é¤˜é¡ã€‚

è«‹æ±‚é ­ï¼š
```json header
Authorization: Bearer {access_token}
```

å›æ‡‰ç¯„ä¾‹ï¼š
```json response
{
  "id": 12345,
  "username": "user123",
  "email": "user@example.com",
  "quota": 1000000,
  "used_quota": 250000,
  "balance_formatted": "750.00",
  "created_time": 1640995200,
  "status": 1
}
```

## SDK å’Œç¨‹å¼ç¢¼ç¯„ä¾‹

### JavaScript SDK

æˆ‘å€‘æä¾›äº†å®Œæ•´çš„ JavaScript SDKï¼Œæ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

```html
<!DOCTYPE html>
<html>
<head>
    <title>ç¬¬ä¸‰æ–¹æ‡‰ç”¨ç¯„ä¾‹</title>
    <style>
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .user-info { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .login-section { text-align: center; padding: 40px; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>æˆ‘çš„ç¬¬ä¸‰æ–¹æ‡‰ç”¨</h1>
        
        <!-- åŠ è¼‰ç‹€æ…‹ -->
        <div id="loading">
            <p>æª¢æŸ¥ç™»å…¥ç‹€æ…‹ä¸­...</p>
        </div>
        
        <!-- å·²ç™»å…¥ç”¨æˆ¶è³‡è¨Š -->
        <div id="user-info" class="user-info hidden">
            <h2>æ­¡è¿å›ä¾†ï¼</h2>
            <p><strong>ç”¨æˆ¶åï¼š</strong><span id="username"></span></p>
            <p><strong>é›»å­éƒµä»¶ï¼š</strong><span id="email"></span></p>
            <p><strong>å¸³æˆ¶é¤˜é¡ï¼š</strong><span id="balance"></span></p>
            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="refreshBalance()">åˆ·æ–°é¤˜é¡</button>
                <button class="btn btn-primary" onclick="goToTopup()">å¸³æˆ¶å„²å€¼</button>
                <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>
        
        <!-- æœªç™»å…¥ç‹€æ…‹ -->
        <div id="login-section" class="login-section hidden">
            <h2>è«‹ç™»å…¥ä»¥æŸ¥çœ‹å¸³æˆ¶è³‡è¨Š</h2>
            <p>ä½¿ç”¨ä¸€éµç™»å…¥å¿«é€Ÿå­˜å–æ‚¨çš„å¸³æˆ¶</p>
            <button class="btn btn-primary" onclick="oneClickLogin()">
                ğŸš€ ä¸€éµç™»å…¥
            </button>
        </div>
    </div>

    <script>
        // OAuthé…ç½®
        const OAUTH_CONFIG = {
            authServer: 'https://your-domain.com',
            clientId: 'YOUR_CLIENT_ID',
            clientSecret: 'YOUR_CLIENT_SECRET', // ç”Ÿç”¢ç’°å¢ƒæ‡‰è©²åœ¨å¾Œç«¯è™•ç†
            redirectUri: window.location.origin + '/oauth/callback.html',
            scope: 'profile balance'
        };

        class OAuthManager {
            constructor() {
                this.accessToken = localStorage.getItem('oauth_access_token');
                this.refreshToken = localStorage.getItem('oauth_refresh_token');
                this.tokenExpiresAt = localStorage.getItem('oauth_token_expires_at');
                this.isRefreshing = false; // é˜²æ­¢ä¸¦ç™¼åˆ·æ–°
                this.init();
            }

            async init() {
                // æª¢æŸ¥URLä¸­æ˜¯å¦æœ‰æˆæ¬Šç¢¼
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');

                if (code) {
                    await this.handleAuthCallback(code, state);
                    // æ¸…ç†URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else if (this.accessToken) {
                    try {
                        // æª¢æŸ¥tokenæ˜¯å¦éæœŸï¼Œå¦‚æœéæœŸå˜—è©¦åˆ·æ–°
                        if (this.isTokenExpired()) {
                            await this.refreshTokenIfNeeded();
                        }
                        await this.fetchUserInfo();
                        this.showUserInfo();
                    } catch (error) {
                        console.log('Tokenå¯èƒ½å·²éæœŸæˆ–ç„¡æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å…¥');
                        this.clearTokens();
                        this.showLoginSection();
                    }
                } else {
                    this.showLoginSection();
                }

                document.getElementById('loading').classList.add('hidden');
            }

            // æª¢æŸ¥access tokenæ˜¯å¦éæœŸ
            isTokenExpired() {
                if (!this.tokenExpiresAt) return false;
                const expiryTime = parseInt(this.tokenExpiresAt);
                const bufferTime = 5 * 60 * 1000; // 5åˆ†é˜ç·©è¡æ™‚é–“
                return Date.now() > (expiryTime - bufferTime);
            }

            // è‡ªå‹•åˆ·æ–°token
            async refreshTokenIfNeeded() {
                if (!this.refreshToken || this.isRefreshing) {
                    return false;
                }

                this.isRefreshing = true;
                
                try {
                    const response = await fetch(`${OAUTH_CONFIG.authServer}/api/oauth2/token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            grant_type: 'refresh_token',
                            refresh_token: this.refreshToken,
                            client_id: OAUTH_CONFIG.clientId,
                            client_secret: OAUTH_CONFIG.clientSecret,
                        })
                    });

                    if (response.ok) {
                        const tokenData = await response.json();
                        this.updateTokens(tokenData);
                        return true;
                    } else {
                        throw new Error('Token refresh failed');
                    }
                } catch (error) {
                    console.error('åˆ·æ–°tokenå¤±æ•—:', error);
                    this.clearTokens();
                    return false;
                } finally {
                    this.isRefreshing = false;
                }
            }

            // æ›´æ–°tokenè³‡è¨Š
            updateTokens(tokenData) {
                this.accessToken = tokenData.access_token;
                this.refreshToken = tokenData.refresh_token;
                this.tokenExpiresAt = Date.now() + (tokenData.expires_in * 1000);

                localStorage.setItem('oauth_access_token', this.accessToken);
                localStorage.setItem('oauth_refresh_token', this.refreshToken);
                localStorage.setItem('oauth_token_expires_at', this.tokenExpiresAt.toString());
            }

            oneClickLogin() {
                const state = this.generateState();
                localStorage.setItem('oauth_state', state);

                const authUrl = `${OAUTH_CONFIG.authServer}/api/oauth2/authorize?` +
                    `client_id=${OAUTH_CONFIG.clientId}&` +
                    `redirect_uri=${encodeURIComponent(OAUTH_CONFIG.redirectUri)}&` +
                    `response_type=code&` +
                    `scope=${encodeURIComponent(OAUTH_CONFIG.scope)}&` +
                    `state=${state}&` +
                    `auto_authorize=true`; // å•Ÿç”¨è‡ªå‹•æˆæ¬Šï¼Œå¯¦ç¾çœŸæ­£çš„ä¸€éµç™»å…¥

                // åœ¨å½ˆçª—ä¸­æ‰“é–‹æˆæ¬Šé é¢
                const popup = window.open(authUrl, 'oauth_login', 'width=500,height=600,scrollbars=yes');

                // ç›£è½å½ˆçª—é—œé–‰
                const checkClosed = setInterval(() => {
                    if (popup.closed) {
                        clearInterval(checkClosed);
                        // æª¢æŸ¥æ˜¯å¦ç²å¾—äº†æˆæ¬Š
                        setTimeout(() => this.init(), 1000);
                    }
                }, 1000);
            }

            async handleAuthCallback(code, state) {
                const savedState = localStorage.getItem('oauth_state');
                if (state !== savedState) {
                    console.error('Stateåƒæ•¸ä¸åŒ¹é…');
                    return;
                }

                try {
                    const response = await fetch(`${OAUTH_CONFIG.authServer}/api/oauth2/token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            grant_type: 'authorization_code',
                            code: code,
                            client_id: OAUTH_CONFIG.clientId,
                            client_secret: OAUTH_CONFIG.clientSecret,
                            redirect_uri: OAUTH_CONFIG.redirectUri
                        })
                    });

                    const tokenData = await response.json();
                    
                    if (tokenData.access_token) {
                        this.updateTokens(tokenData);
                        localStorage.removeItem('oauth_state');
                        
                        await this.fetchUserInfo();
                        this.showUserInfo();
                    }
                } catch (error) {
                    console.error('ç²å–è¨ªå•ä»¤ç‰Œå¤±æ•—:', error);
                }
            }

            // å¸¶è‡ªå‹•åˆ·æ–°çš„APIè«‹æ±‚æ–¹æ³•
            async apiRequest(url, options = {}) {
                // æª¢æŸ¥ä¸¦åˆ·æ–°token
                if (this.isTokenExpired()) {
                    const refreshed = await this.refreshTokenIfNeeded();
                    if (!refreshed) {
                        throw new Error('Unable to refresh token');
                    }
                }

                const headers = {
                    'Authorization': `Bearer ${this.accessToken}`,
                    ...options.headers
                };

                const response = await fetch(url, {
                    ...options,
                    headers
                });

                // å¦‚æœæ”¶åˆ°401éŒ¯èª¤ï¼Œå˜—è©¦åˆ·æ–°tokenä¸¦é‡è©¦ä¸€æ¬¡
                if (response.status === 401 && !options._retry) {
                    const refreshed = await this.refreshTokenIfNeeded();
                    if (refreshed) {
                        return this.apiRequest(url, { ...options, _retry: true });
                    }
                }

                return response;
            }

            async fetchUserInfo() {
                const response = await this.apiRequest(`${OAUTH_CONFIG.authServer}/api/oauth2/userinfo`);

                if (!response.ok) {
                    throw new Error('ç²å–ç”¨æˆ¶è³‡è¨Šå¤±æ•—');
                }

                this.userInfo = await response.json();
            }

            showUserInfo() {
                document.getElementById('username').textContent = this.userInfo.username;
                document.getElementById('email').textContent = this.userInfo.email;
                document.getElementById('balance').textContent = this.userInfo.balance_formatted;

                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('login-section').classList.add('hidden');
            }

            showLoginSection() {
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('login-section').classList.remove('hidden');
            }

            async refreshBalance() {
                try {
                    await this.fetchUserInfo();
                    document.getElementById('balance').textContent = this.userInfo.balance_formatted;
                    alert('é¤˜é¡å·²æ›´æ–°');
                } catch (error) {
                    alert('åˆ·æ–°å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
                    this.clearTokens();
                    this.showLoginSection();
                }
            }

            async goToTopup() {
                try {
                    const response = await this.apiRequest(`${OAUTH_CONFIG.authServer}/api/oauth2/topup`);

                    const data = await response.json();
                    if (data.topup_url) {
                        window.open(data.topup_url, '_blank');
                    }
                } catch (error) {
                    console.error('ç²å–å„²å€¼é€£çµå¤±æ•—:', error);
                }
            }

            logout() {
                this.clearTokens();
                this.showLoginSection();
            }

            clearTokens() {
                this.accessToken = null;
                this.refreshToken = null;
                this.tokenExpiresAt = null;
                this.userInfo = null;
                
                localStorage.removeItem('oauth_access_token');
                localStorage.removeItem('oauth_refresh_token');
                localStorage.removeItem('oauth_token_expires_at');
            }

            generateState() {
                return Math.random().toString(36).substring(2, 15) + 
                       Math.random().toString(36).substring(2, 15);
            }
        }

        // å…¨åŸŸå‡½æ•¸
        let oauthManager;

        function oneClickLogin() {
            oauthManager.oneClickLogin();
        }

        function refreshBalance() {
            oauthManager.refreshBalance();
        }

        function goToTopup() {
            oauthManager.goToTopup();
        }

        function logout() {
            oauthManager.logout();
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            oauthManager = new OAuthManager();
        });
    </script>
</body>
</html>
```

### OAuth å›èª¿é é¢

å»ºç«‹ `/oauth/callback.html` æ–‡ä»¶ï¼š

```html
<!DOCTYPE html>
<html>
<head>
    <title>ç™»å…¥è™•ç†ä¸­...</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        .loading { color: #666; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h2>ç™»å…¥è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</h2>
    <div id="status" class="loading">æ­£åœ¨é©—è­‰æˆæ¬Šè³‡è¨Š...</div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');

        if (error) {
            document.getElementById('status').innerHTML = 
                `<div class="error">æˆæ¬Šå¤±æ•—: ${error}</div>`;
            setTimeout(() => {
                if (window.opener) {
                    window.close();
                } else {
                    window.location.href = '/';
                }
            }, 3000);
        } else if (code) {
            if (window.opener) {
                // å¦‚æœæ˜¯å½ˆçª—ï¼Œé—œé–‰ä¸¦è®“çˆ¶è¦–çª—è™•ç†
                window.opener.location.href = 
                    window.opener.location.pathname + `?code=${code}&state=${state}`;
                window.close();
            } else {
                // å¦‚æœä¸æ˜¯å½ˆçª—ï¼Œé‡å®šå‘åˆ°ä¸»é é¢
                window.location.href = `/?code=${code}&state=${state}`;
            }
        } else {
            document.getElementById('status').innerHTML = 
                '<div class="error">æœªæ”¶åˆ°æœ‰æ•ˆçš„æˆæ¬Šè³‡è¨Š</div>';
            setTimeout(() => {
                window.location.href = '/';
            }, 3000);
        }
    </script>
</body>
</html>
```

### Node.js å¾Œç«¯ç¯„ä¾‹

ç‚ºäº†æ›´å¥½çš„å®‰å…¨æ€§ï¼Œå»ºè­°åœ¨å¾Œç«¯è™•ç† `client_secret`ï¼š

```js
const express = require('express');
const cors = require('cors');
const fetch = require('node-fetch');

const app = express();
app.use(cors());
app.use(express.json());

const OAUTH_CONFIG = {
    authServer: 'https://your-domain.com',
    clientId: 'YOUR_CLIENT_ID',
    clientSecret: 'YOUR_CLIENT_SECRET'
};

// å¾Œç«¯è™•ç†tokenäº¤æ›
app.post('/api/oauth/exchange-token', async (req, res) => {
    const { code, redirectUri, state } = req.body;

    try {
        const response = await fetch(`${OAUTH_CONFIG.authServer}/api/oauth2/token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                client_id: OAUTH_CONFIG.clientId,
                client_secret: OAUTH_CONFIG.clientSecret,
                redirect_uri: redirectUri
            })
        });

        const tokenData = await response.json();
        
        if (response.ok) {
            res.json(tokenData);
        } else {
            res.status(400).json(tokenData);
        }
    } catch (error) {
        res.status(500).json({ error: 'Token exchange failed' });
    }
});

// åˆ·æ–°tokenç«¯é»
app.post('/api/oauth/refresh-token', async (req, res) => {
    const { refreshToken } = req.body;

    if (!refreshToken) {
        return res.status(400).json({ error: 'Missing refresh token' });
    }

    try {
        const response = await fetch(`${OAUTH_CONFIG.authServer}/api/oauth2/token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                grant_type: 'refresh_token',
                refresh_token: refreshToken,
                client_id: OAUTH_CONFIG.clientId,
                client_secret: OAUTH_CONFIG.clientSecret,
            })
        });

        const tokenData = await response.json();
        
        if (response.ok) {
            res.json(tokenData);
        } else {
            res.status(400).json(tokenData);
        }
    } catch (error) {
        res.status(500).json({ error: 'Token refresh failed' });
    }
});

// ä»£ç†ç”¨æˆ¶è³‡è¨Šè«‹æ±‚ï¼ˆå¸¶è‡ªå‹•åˆ·æ–°ï¼‰
app.get('/api/oauth/userinfo', async (req, res) => {
    const authHeader = req.headers.authorization;
    
    if (!authHeader) {
        return res.status(401).json({ error: 'Missing authorization header' });
    }

    try {
        const response = await fetch(`${OAUTH_CONFIG.authServer}/api/oauth2/userinfo`, {
            headers: {
                'Authorization': authHeader
            }
        });

        const userData = await response.json();
        
        if (response.ok) {
            res.json(userData);
        } else {
            res.status(response.status).json(userData);
        }
    } catch (error) {
        res.status(500).json({ error: 'Failed to fetch user info' });
    }
});

app.listen(3000, () => {
    console.log('Server running on port 3000');
});
```

## å®‰å…¨æœ€ä½³å¯¦è¸

### 1. å®¢æˆ¶ç«¯å¯†é‘°ä¿è­·

- âœ… æ¨è–¦ï¼šå°‡ `client_secret` å„²å­˜åœ¨å¾Œç«¯ä¼ºæœå™¨
- âŒ é¿å…ï¼šåœ¨å‰ç«¯JavaScriptä¸­æš´éœ² `client_secret`

### 2. State åƒæ•¸é©—è­‰

```js
// ç”Ÿæˆéš¨æ©Ÿstate
const state = crypto.randomBytes(16).toString('hex');
localStorage.setItem('oauth_state', state);

// é©—è­‰state
const savedState = localStorage.getItem('oauth_state');
if (receivedState !== savedState) {
    throw new Error('CSRF attack detected');
}
```

### 3. HTTPS ä½¿ç”¨

- ç”Ÿç”¢ç’°å¢ƒå¿…é ˆä½¿ç”¨ `HTTPS`
- å›èª¿åœ°å€å¿…é ˆä½¿ç”¨ `HTTPS`
- æ‰€æœ‰ API è«‹æ±‚ä½¿ç”¨ `HTTPS`

### 4. Token å®‰å…¨å„²å­˜

```js
// è¨­å®š token éæœŸæ™‚é–“
const expiryTime = Date.now() + (tokenData.expires_in * 1000);
localStorage.setItem('oauth_token_expiry', expiryTime);

// æª¢æŸ¥tokenæ˜¯å¦éæœŸ
function isTokenExpired() {
    const expiry = localStorage.getItem('oauth_token_expiry');
    return !expiry || Date.now() > parseInt(expiry);
}
```

### 5. éŒ¯èª¤è™•ç†

```js
try {
    const response = await fetch('/api/oauth2/userinfo', {
        headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!response.ok) {
        if (response.status === 401) {
            // TokenéæœŸï¼Œéœ€è¦é‡æ–°ç™»å…¥
            clearToken();
            showLoginSection();
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    }
    
    const userInfo = await response.json();
    return userInfo;
} catch (error) {
    console.error('API request failed:', error);
    // è™•ç†ç¶²è·¯éŒ¯èª¤ç­‰
}
```

## å¸¸è¦‹å•é¡Œ

### Q1: å¦‚ä½•å¯¦ç¾çœŸæ­£çš„ä¸€éµç™»å…¥é«”é©—ï¼Ÿ

A: åœ¨æˆæ¬ŠURLä¸­æ·»åŠ  `auto_authorize=true` åƒæ•¸å³å¯ã€‚é€™æ¨£ç”¨æˆ¶ç™»å…¥å®Œæˆå¾Œæœƒè‡ªå‹•å®Œæˆæˆæ¬Šï¼Œç„¡éœ€é¡å¤–çš„ç¢ºèªæ­¥é©Ÿï¼š

```js
const authUrl = 'https://your-domain.com/api/oauth2/authorize?' +
  'client_id=YOUR_CLIENT_ID&' +
  'auto_authorize=true&' + // é—œéµåƒæ•¸
  '...å…¶ä»–åƒæ•¸';
```

### Q2: Token æœƒè‡ªå‹•åˆ·æ–°å—ï¼Ÿ

A: æ˜¯çš„ï¼Œæˆ‘å€‘çš„ SDK å…§ç½®äº†è‡ªå‹• token åˆ·æ–°æ©Ÿåˆ¶ï¼š

- å­˜å–ä»¤ç‰Œï¼š2å°æ™‚æœ‰æ•ˆæœŸï¼ŒéæœŸå‰ 5 åˆ†é˜è‡ªå‹•åˆ·æ–°
- åˆ·æ–°ä»¤ç‰Œï¼š30å¤©æœ‰æ•ˆæœŸï¼Œç”¨æ–¼ç²å–æ–°çš„å­˜å–ä»¤ç‰Œ
- ç„¡æ„Ÿåˆ·æ–°ï¼šæ‰€æœ‰ API å‘¼å«éƒ½æœƒè‡ªå‹•æª¢æŸ¥ä¸¦åˆ·æ–°éæœŸçš„ token
- å¤±æ•—é‡è©¦ï¼šå¦‚æœ API è¿”å› 401 éŒ¯èª¤ï¼Œæœƒè‡ªå‹•å˜—è©¦åˆ·æ–° token ä¸¦é‡è©¦

```js
// SDK æœƒè‡ªå‹•è™•ç† token åˆ·æ–°ï¼Œæ‚¨ç„¡éœ€æ‰‹å‹•è™•ç†
const userInfo = await oauthManager.fetchUserInfo(); // è‡ªå‹•åˆ·æ–°token
```

åªæœ‰åœ¨åˆ·æ–°ä»¤ç‰Œä¹ŸéæœŸæ™‚ï¼Œæ‰éœ€è¦ç”¨æˆ¶é‡æ–°ç™»å…¥ã€‚

### Q3: å¯ä»¥ç²å–å“ªäº›ç”¨æˆ¶è³‡è¨Šï¼Ÿ

A: æ ¹æ“šæˆæ¬Š scopeï¼Œæ‚¨å¯ä»¥ç²å–ï¼š
- `profile` scope: ç”¨æˆ¶åã€é›»å­éƒµä»¶
- `balance` scope: å¸³æˆ¶é¤˜é¡è³‡è¨Š

### Q4: å¦‚ä½•æ¸¬è©¦ OAuth æ•´åˆï¼Ÿ

A: 
1. åœ¨é–‹ç™¼ç’°å¢ƒä¸­ä½¿ç”¨ `HTTP localhost` é€²è¡Œæ¸¬è©¦
2. ä½¿ç”¨æˆ‘å€‘æä¾›çš„æ¸¬è©¦å·¥å…·é©—è­‰æˆæ¬Šæµç¨‹
3. æª¢æŸ¥ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ä¸­çš„ç¶²è·¯è«‹æ±‚

### Q5: æ”¯æ´å“ªäº›ç¨‹å¼èªè¨€ï¼Ÿ

A: æˆ‘å€‘æä¾›æ¨™æº–çš„OAuth2 APIï¼Œæ”¯æ´æ‰€æœ‰ä¸»æµç¨‹å¼èªè¨€ï¼š
- JavaScript/Node.js
- Python
- PHP
- Java
- C#/.NET
- Go
- Ruby

### Q6: å¦‚ä½•æ’¤éŠ·ç”¨æˆ¶æˆæ¬Šï¼Ÿ

A: ç”¨æˆ¶å¯ä»¥åœ¨æˆ‘å€‘çš„ç”¨æˆ¶ä¸­å¿ƒ > æˆæ¬Šç®¡ç†é é¢æ’¤éŠ·å°ç¬¬ä¸‰æ–¹æ‡‰ç”¨çš„æˆæ¬Šã€‚