---
title: "ç¬¬ä¸‰æ–¹åº”ç”¨æ¥å…¥æŒ‡å—"
description: " "
icon: "webhook"
---

## é‡è¦å®‰å…¨å£°æ˜

å®‰å…¨ç¬¬ä¸€åŸåˆ™ï¼šåœ¨å¼€å‘å’Œéƒ¨ç½²ç¬¬ä¸‰æ–¹åº”ç”¨æ—¶ï¼Œå®‰å…¨æ€§æ˜¯æœ€é‡è¦çš„è€ƒè™‘å› ç´ ã€‚å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹å®‰å…¨åŸåˆ™ï¼Œç¡®ä¿ç”¨æˆ·æ•°æ®å’Œæˆæƒæµç¨‹çš„å®‰å…¨æ€§ã€‚

<Warning>
1. ç»å¯¹ç¦æ­¢åœ¨å‰ç«¯ JavaScript ä»£ç ä¸­æš´éœ² `client_secret`
2. å¿…é¡»åœ¨æœåŠ¡å™¨ç«¯å¤„ç† OAuth æˆæƒç äº¤æ¢ token çš„è¿‡ç¨‹
3. å¿…é¡»é€šè¿‡åç«¯ API ä»£ç†è®¿é—®å—ä¿æŠ¤çš„ç”¨æˆ·èµ„æº
4. å¿…é¡»ä½¿ç”¨ HTTPS åè®®ä¿æŠ¤æ‰€æœ‰ OAuth é€šä¿¡
</Warning>

è¿åä»¥ä¸Šä»»ä½•ä¸€æ¡å®‰å…¨åŸåˆ™éƒ½å¯èƒ½å¯¼è‡´ä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¥å…¥å‡†å¤‡](#æ¥å…¥å‡†å¤‡)
3. [OAuth2 æˆæƒæµç¨‹](#oauth2æˆæƒæµç¨‹)
4. [APIæ¥å£æ–‡æ¡£](#apiæ¥å£æ–‡æ¡£)
5. [SDKå’Œä»£ç ç¤ºä¾‹](#sdkå’Œä»£ç ç¤ºä¾‹)
6. [å®‰å…¨æœ€ä½³å®è·µ](#å®‰å…¨æœ€ä½³å®è·µ)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
8. [æŠ€æœ¯æ”¯æŒ](#æŠ€æœ¯æ”¯æŒ)

## æ¦‚è¿°

æˆ‘ä»¬æä¾›åŸºäº OAuth2 æ ‡å‡†çš„å¼€æ”¾ APIï¼Œå…è®¸ç¬¬ä¸‰æ–¹åº”ç”¨å®‰å…¨åœ°è®¿é—®ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯å’Œè´¦æˆ·ä½™é¢ã€‚é€šè¿‡æˆ‘ä»¬çš„ OAuth2 æœåŠ¡ï¼Œæ‚¨çš„åº”ç”¨å¯ä»¥ï¼š

- ğŸš€ ä¸€é”®ç™»å½•ï¼šç”¨æˆ·æ— éœ€é‡å¤æ³¨å†Œï¼Œç™»å½•å®Œæˆå³è‡ªåŠ¨æˆæƒï¼ŒçœŸæ­£çš„æ— ç¼ä½“éªŒ
- ğŸ‘¤ è·å–ç”¨æˆ·ä¿¡æ¯ï¼šè®¿é—®ç”¨æˆ·çš„åŸºæœ¬èµ„æ–™ï¼ˆç”¨æˆ·åã€é‚®ç®±ç­‰ï¼‰
- ğŸ’° æŸ¥çœ‹è´¦æˆ·ä½™é¢ï¼šå®æ—¶è·å–ç”¨æˆ·çš„è´¦æˆ·ä½™é¢ä¿¡æ¯
- ğŸ”„ å……å€¼è·³è½¬ï¼šå¼•å¯¼ç”¨æˆ·åˆ°æˆ‘ä»¬çš„å……å€¼é¡µé¢è¿›è¡Œè´¦æˆ·å……å€¼
- ğŸ” è‡ªåŠ¨tokenåˆ·æ–°ï¼šå†…ç½® refresh token æœºåˆ¶ï¼Œæ— æ„Ÿåˆ·æ–°è¿‡æœŸ tokenï¼Œæå‡ç”¨æˆ·ä½“éªŒ

## æ¥å…¥å‡†å¤‡

### 1. æ³¨å†Œå¼€å‘è€…è´¦æˆ·

é¦–å…ˆï¼Œæ‚¨éœ€è¦åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­æ³¨å†Œä¸€ä¸ªå¼€å‘è€…è´¦æˆ·ã€‚

### 2. åˆ›å»º OAuth åº”ç”¨

åœ¨å¼€å‘è€…æ§åˆ¶å°ä¸­åˆ›å»ºæ‚¨çš„ OAuth åº”ç”¨ï¼š

```shell API è°ƒç”¨ç¤ºä¾‹
curl -X POST https://api.aihubmix.com/api/oauth_apps \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_DEVELOPER_TOKEN" \
  -d '{
    "name": "æˆ‘çš„ç¬¬ä¸‰æ–¹åº”ç”¨",
    "description": "åº”ç”¨æè¿°ä¿¡æ¯",
    "redirect_uri": "https://yourapp.com/oauth/callback"
  }'
```

å“åº”ç¤ºä¾‹ï¼š

```json
{
  "success": true,
  "message": "åº”ç”¨åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": 1,
    "name": "æˆ‘çš„ç¬¬ä¸‰æ–¹åº”ç”¨",
    "client_id": "client_abc123def456...",
    "client_secret": "secret_xyz789uvw012...",
    "redirect_uri": "https://yourapp.com/oauth/callback",
    "created_time": 1640995200
  }
}
```

å®‰å…¨é‡è¦æé†’ï¼š
<Warning>
- client_id å¯ä»¥åœ¨å‰ç«¯ä½¿ç”¨ï¼ˆå…¬å¼€ä¿¡æ¯ï¼‰
- `client_secret` åªèƒ½åœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨ï¼Œç»ä¸èƒ½æš´éœ²ç»™æµè§ˆå™¨
- è¯·å°† client_secret å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­ï¼Œä¸è¦ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
</Warning>

### 3. é…ç½®å›è°ƒåœ°å€

ç¡®ä¿æ‚¨çš„å›è°ƒåœ°å€ï¼ˆredirect_uriï¼‰æ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š

- ä½¿ç”¨HTTPSåè®®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- æŒ‡å‘æ‚¨çš„æœåŠ¡å™¨ç«¯ç‚¹ï¼ˆè€Œéå‰ç«¯é¡µé¢ï¼‰
- åŸŸåå·²å¤‡æ¡ˆä¸”å¯æ­£å¸¸è®¿é—®
- è·¯å¾„å…·ä½“åˆ°å¤„ç†å›è°ƒçš„APIç«¯ç‚¹

## OAuth2 æˆæƒæµç¨‹

### å®‰å…¨æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant Browser  as ç”¨æˆ·æµè§ˆå™¨
    participant Backend  as æ‚¨çš„æœåŠ¡å™¨
    participant OAuthSrv as æˆ‘ä»¬çš„æœåŠ¡å™¨

    %% ç™»å½•å…¥å£
    Browser  ->> Backend : GET /auth<br>(ç”¨æˆ·ç‚¹å‡»ç™»å½•)

    %% ç”Ÿæˆå¹¶ä¿å­˜ stateï¼Œéšåè·³è½¬
    Backend  ->> Backend : ç”Ÿæˆ state<br>å­˜å‚¨ state
    Backend  ->> OAuthSrv: é‡å®šå‘åˆ°æˆæƒ<br>(å¸¦ client_id)

    %% å±•ç¤ºæˆæƒé¡µå¹¶å®Œæˆæˆæƒ
    OAuthSrv -->> Browser : æ˜¾ç¤ºæˆæƒé¡µé¢
    Browser  ->> Browser : ç”¨æˆ·å®Œæˆæˆæƒ

    %% æˆæƒæœåŠ¡å™¨é€šè¿‡æµè§ˆå™¨å›è°ƒ
    Browser  ->> Backend : GET /callback
    Backend  ->> Backend : éªŒè¯ state
    Backend  ->> OAuthSrv: ç”¨æˆæƒç æ¢ token<br>(å¸¦ secret)
    OAuthSrv -->> Backend : éªŒè¯å¹¶è¿”å› token

    %% ä¿å­˜ token å¹¶å›åˆ°å‰ç«¯
    Backend  ->> Backend : å­˜å‚¨ token
    Backend  -->> Browser : é‡å®šå‘åˆ°å‰ç«¯

    %% æ‹‰å–ç”¨æˆ·ä¿¡æ¯
    Browser  ->> Browser : æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    Browser  ->> Backend : GET /api/user
    Backend  ->> OAuthSrv: ç”¨ token è¯·æ±‚ç”¨æˆ·ä¿¡æ¯
    OAuthSrv -->> Backend : è¿”å›ç”¨æˆ·ä¿¡æ¯
    Backend  -->> Browser : è¿”å›ç”¨æˆ·ä¿¡æ¯
```

### è¯¦ç»†æ­¥éª¤

#### æ­¥éª¤ 1ï¼šå¼•å¯¼ç”¨æˆ·æˆæƒ

åœ¨æ‚¨çš„å‰ç«¯é¡µé¢æ·»åŠ ç™»å½•æŒ‰é’®ï¼Œç‚¹å‡»åé‡å®šå‘åˆ°æ‚¨çš„æœåŠ¡å™¨ç«¯æˆæƒç«¯ç‚¹ï¼š

```js å‰ç«¯ä»£ç  - åªè´Ÿè´£é‡å®šå‘
function startLogin() {
    // é‡å®šå‘åˆ°æ‚¨çš„æœåŠ¡å™¨ç«¯æˆæƒå¤„ç†ç«¯ç‚¹
    window.location.href = '/auth/oauth/start';
}
```

#### æ­¥éª¤ 2ï¼šæœåŠ¡å™¨ç«¯å¤„ç†æˆæƒè¯·æ±‚

åœ¨æ‚¨çš„æœåŠ¡å™¨ç«¯å®ç°æˆæƒå¤„ç†ï¼š

```js æœåŠ¡å™¨ç«¯ä»£ç 
app.get('/auth/oauth/start', (req, res) => {
    // ç”Ÿæˆå¹¶å­˜å‚¨stateå‚æ•°
    const state = generateSecureRandomString();
    req.session.oauth_state = state;
    
    // æ„å»ºæˆæƒURL
    const authUrl = new URL('https://your-domain.com/api/oauth2/authorize');
    authUrl.searchParams.append('client_id', process.env.OAUTH_CLIENT_ID);
    authUrl.searchParams.append('redirect_uri', process.env.OAUTH_REDIRECT_URI);
    authUrl.searchParams.append('response_type', 'code');
    authUrl.searchParams.append('scope', 'profile balance');
    authUrl.searchParams.append('state', state);
    authUrl.searchParams.append('auto_authorize', 'true'); // ä¸€é”®ç™»å½•
    
    // é‡å®šå‘åˆ°æˆæƒæœåŠ¡å™¨
    res.redirect(authUrl.toString());
});
```

#### æ­¥éª¤ 3ï¼šå¤„ç†æˆæƒå›è°ƒï¼ˆæœåŠ¡å™¨ç«¯ï¼‰

```js æœåŠ¡å™¨ç«¯å¤„ç†æˆæƒå›è°ƒ
app.get('/oauth/callback', async (req, res) => {
    const { code, state, error } = req.query;
    
    // é”™è¯¯å¤„ç†
    if (error) {
        return res.redirect(`/?error=${encodeURIComponent(error)}`);
    }
    
    // å‚æ•°éªŒè¯
    if (!code || !state) {
        return res.redirect('/?error=missing_parameters');
    }
    
    // éªŒè¯stateå‚æ•°ï¼ˆé˜²CSRFæ”»å‡»ï¼‰
    if (state !== req.session.oauth_state) {
        return res.redirect('/?error=invalid_state');
    }
    
    try {
        // ç”¨æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œï¼ˆåœ¨æœåŠ¡å™¨ç«¯å®Œæˆï¼‰
        const tokenResponse = await fetch('https://your-domain.com/api/oauth2/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: process.env.OAUTH_REDIRECT_URI,
                client_id: process.env.OAUTH_CLIENT_ID,
                client_secret: process.env.OAUTH_CLIENT_SECRET // åªåœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨
            })
        });
        
        const tokenData = await tokenResponse.json();
        
        if (!tokenResponse.ok) {
            throw new Error(tokenData.error || 'Token exchange failed');
        }
        
        // å®‰å…¨å­˜å‚¨tokenï¼ˆæœåŠ¡å™¨ç«¯sessionæˆ–æ•°æ®åº“ï¼‰
        req.session.access_token = tokenData.access_token;
        req.session.refresh_token = tokenData.refresh_token;
        req.session.token_expires_at = Date.now() + (tokenData.expires_in * 1000);
        
        // æ¸…ç†ä¸´æ—¶çŠ¶æ€
        delete req.session.oauth_state;
        
        // é‡å®šå‘åˆ°å‰ç«¯é¡µé¢
        res.redirect('/?login=success');
        
    } catch (error) {
        console.error('OAuth callback error:', error);
        res.redirect(`/?error=server_error`);
    }
});
```

#### æ­¥éª¤ 4ï¼šå‰ç«¯è·å–ç”¨æˆ·ä¿¡æ¯

```js å‰ç«¯é€šè¿‡ API ä»£ç†è·å–ç”¨æˆ·ä¿¡æ¯
async function loadUserInfo() {
    try {
        const response = await fetch('/api/user/info');
        
        if (!response.ok) {
            throw new Error('Failed to fetch user info');
        }
        
        const userInfo = await response.json();
        displayUserInfo(userInfo);
        
    } catch (error) {
        console.error('Failed to load user info:', error);
        showLoginButton();
    }
}
```

```js æœåŠ¡å™¨ç«¯APIä»£ç†
app.get('/api/user/info', async (req, res) => {
    const accessToken = req.session.access_token;
    
    if (!accessToken) {
        return res.status(401).json({ error: 'Not authenticated' });
    }
    
    try {
        // ä»£ç†è¯·æ±‚åˆ°OAuthæœåŠ¡å™¨
        const response = await fetch('https://your-domain.com/api/oauth2/userinfo', {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });
        
        if (!response.ok) {
            throw new Error('User info request failed');
        }
        
        const userInfo = await response.json();
        res.json(userInfo);
        
    } catch (error) {
        console.error('User info proxy error:', error);
        res.status(500).json({ error: 'Server error' });
    }
});
```

<Tips>
ä¸€é”®ç™»å½•ä½“éªŒï¼šè®¾ç½® `auto_authorize=true` åï¼Œç”¨æˆ·åªéœ€è¦å®Œæˆç™»å½•æ“ä½œï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å®Œæˆæˆæƒï¼Œæ— éœ€é¢å¤–çš„ç¡®è®¤æ­¥éª¤ã€‚
</Tips>

## API æ¥å£æ–‡æ¡£

### 1. æˆæƒç«¯ç‚¹

GET `/api/oauth2/authorize`

å¼•å¯¼ç”¨æˆ·è¿›è¡Œ OAuth2 æˆæƒã€‚

å‚æ•°ï¼š
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
| --- | --- | --- | --- |
| `client_id` | string | æ˜¯ | åº”ç”¨çš„å®¢æˆ·ç«¯IDï¼ˆå¯åœ¨å‰ç«¯ä½¿ç”¨ï¼‰ |
| `redirect_uri` | string | æ˜¯ | æˆæƒåçš„å›è°ƒåœ°å€ï¼ˆå¿…é¡»æŒ‡å‘æœåŠ¡å™¨ç«¯ç‚¹ï¼‰ |
| `response_type` | string | æ˜¯ | å›ºå®šå€¼ï¼š`code` |
| `scope` | string | å¦ | æƒé™èŒƒå›´ï¼Œå¤šä¸ªç”¨ç©ºæ ¼åˆ†éš” |
| `state` | string | å¿…å¡« | é˜²CSRFæ”»å‡»çš„éšæœºå­—ç¬¦ä¸²ï¼ˆæœåŠ¡å™¨ç«¯ç”Ÿæˆï¼‰ |
| `auto_authorize` | string | å¦ | è®¾ä¸º `true` æ—¶å¯ç”¨è‡ªåŠ¨æˆæƒ |

å®‰å…¨è¦æ±‚ï¼š
- `redirect_uri` å¿…é¡»ä¸æ³¨å†Œæ—¶çš„åœ°å€å®Œå…¨åŒ¹é…
- `state` å‚æ•°å¿…é¡»æ˜¯æœåŠ¡å™¨ç«¯ç”Ÿæˆçš„éšæœºå­—ç¬¦ä¸²
- å¿…é¡»ä½¿ç”¨ HTTPS åè®®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

Scope è¯´æ˜ï¼š
- `profile`ï¼šè·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆç”¨æˆ·åã€é‚®ç®±ï¼‰
- `balance`ï¼šè·å–ç”¨æˆ·è´¦æˆ·ä½™é¢ä¿¡æ¯

### 2. ä»¤ç‰Œ(Token)è·å–ç«¯ç‚¹

POST `/api/oauth2/token`

<Warning>
å®‰å…¨è­¦å‘Šï¼šæ­¤ç«¯ç‚¹åªèƒ½ä»æœåŠ¡å™¨ç«¯è°ƒç”¨ï¼Œç»ä¸èƒ½åœ¨å‰ç«¯ä½¿ç”¨ï¼
</Warning>

ç”¨äºä¸¤ç§åœºæ™¯ï¼š
1. ä½¿ç”¨æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œ
2. ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–æ–°çš„è®¿é—®ä»¤ç‰Œ

æˆæƒç æ¨¡å¼å‚æ•°ï¼š
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
| --- | --- | --- | --- |
| `grant_type` | string | æ˜¯ | å›ºå®šå€¼ï¼š`authorization_code` |
| `code` | string | æ˜¯ | æˆæƒç  |
| `redirect_uri` | string | æ˜¯ | å¿…é¡»ä¸æˆæƒæ—¶çš„åœ°å€ä¸€è‡´ |
| `client_id` | string | æ˜¯ | åº”ç”¨çš„å®¢æˆ·ç«¯ ID |
| `client_secret` | string | æ˜¯ | åº”ç”¨çš„å®¢æˆ·ç«¯å¯†é’¥ï¼ˆåªèƒ½åœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨ï¼‰ |


åˆ·æ–°ä»¤ç‰Œå‚æ•°ï¼š
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
| --- | --- | --- | --- |
| `grant_type` | string | æ˜¯ | å›ºå®šå€¼ï¼š`refresh_token` |
| `refresh_token` | string | æ˜¯ | åˆ·æ–°ä»¤ç‰Œ |
| `client_id` | string | æ˜¯ | åº”ç”¨çš„å®¢æˆ·ç«¯ID |
| `client_secret` | string | æ˜¯ | åº”ç”¨çš„å®¢æˆ·ç«¯å¯†é’¥ï¼ˆåªèƒ½åœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨ï¼‰ |

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 7200,
  "refresh_token": "refresh_abc123def456...",
  "scope": "profile balance"
}
```

### 3. ç”¨æˆ·ä¿¡æ¯ç«¯ç‚¹

GET `/api/oauth2/userinfo`

è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’Œè´¦æˆ·ä½™é¢ã€‚

è¯·æ±‚å¤´ï¼š
```json header
Authorization: Bearer {access_token}
```

å“åº”ç¤ºä¾‹ï¼š
```json response
{
  "id": 12345,
  "username": "user123",
  "email": "user@example.com",
  "quota": 1000000,
  "used_quota": 250000,
  "balance_formatted": "750.00",
  "created_time": 1640995200,
  "status": 1
}
```

## SDK å’Œä»£ç ç¤ºä¾‹

### JavaScript SDK

æˆ‘ä»¬æä¾›äº†å®Œæ•´çš„ JavaScript SDKï¼Œæ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

```html
<!DOCTYPE html>
<html>
<head>
    <title>ç¬¬ä¸‰æ–¹åº”ç”¨ç¤ºä¾‹</title>
    <style>
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .user-info { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .login-section { text-align: center; padding: 40px; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>æˆ‘çš„ç¬¬ä¸‰æ–¹åº”ç”¨</h1>
        
        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading">
            <p>æ£€æŸ¥ç™»å½•çŠ¶æ€ä¸­...</p>
        </div>
        
        <!-- å·²ç™»å½•ç”¨æˆ·ä¿¡æ¯ -->
        <div id="user-info" class="user-info hidden">
            <h2>æ¬¢è¿å›æ¥ï¼</h2>
            <p><strong>ç”¨æˆ·åï¼š</strong><span id="username"></span></p>
            <p><strong>é‚®ç®±ï¼š</strong><span id="email"></span></p>
            <p><strong>è´¦æˆ·ä½™é¢ï¼š</strong><span id="balance"></span></p>
            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="refreshBalance()">åˆ·æ–°ä½™é¢</button>
                <button class="btn btn-primary" onclick="goToTopup()">è´¦æˆ·å……å€¼</button>
                <button class="btn btn-secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
        
        <!-- æœªç™»å½•çŠ¶æ€ -->
        <div id="login-section" class="login-section hidden">
            <h2>è¯·ç™»å½•ä»¥æŸ¥çœ‹è´¦æˆ·ä¿¡æ¯</h2>
            <p>ä½¿ç”¨ä¸€é”®ç™»å½•å¿«é€Ÿè®¿é—®æ‚¨çš„è´¦æˆ·</p>
            <button class="btn btn-primary" onclick="oneClickLogin()">
                ğŸš€ ä¸€é”®ç™»å½•
            </button>
        </div>
    </div>

    <script>
        // OAuthé…ç½®
        const OAUTH_CONFIG = {
            authServer: 'https://your-domain.com',
            clientId: 'YOUR_CLIENT_ID',
            clientSecret: 'YOUR_CLIENT_SECRET', // ç”Ÿäº§ç¯å¢ƒåº”è¯¥åœ¨åç«¯å¤„ç†
            redirectUri: window.location.origin + '/oauth/callback.html',
            scope: 'profile balance'
        };

        class OAuthManager {
            constructor() {
                this.accessToken = localStorage.getItem('oauth_access_token');
                this.refreshToken = localStorage.getItem('oauth_refresh_token');
                this.tokenExpiresAt = localStorage.getItem('oauth_token_expires_at');
                this.isRefreshing = false; // é˜²æ­¢å¹¶å‘åˆ·æ–°
                this.init();
            }

            async init() {
                // æ£€æŸ¥URLä¸­æ˜¯å¦æœ‰æˆæƒç 
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');

                if (code) {
                    await this.handleAuthCallback(code, state);
                    // æ¸…ç†URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else if (this.accessToken) {
                    try {
                        // æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸå°è¯•åˆ·æ–°
                        if (this.isTokenExpired()) {
                            await this.refreshTokenIfNeeded();
                        }
                        await this.fetchUserInfo();
                        this.showUserInfo();
                    } catch (error) {
                        console.log('Tokenå¯èƒ½å·²è¿‡æœŸæˆ–æ— æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•');
                        this.clearTokens();
                        this.showLoginSection();
                    }
                } else {
                    this.showLoginSection();
                }

                document.getElementById('loading').classList.add('hidden');
            }

            // æ£€æŸ¥access tokenæ˜¯å¦è¿‡æœŸ
            isTokenExpired() {
                if (!this.tokenExpiresAt) return false;
                const expiryTime = parseInt(this.tokenExpiresAt);
                const bufferTime = 5 * 60 * 1000; // 5åˆ†é’Ÿç¼“å†²æ—¶é—´
                return Date.now() > (expiryTime - bufferTime);
            }

            // è‡ªåŠ¨åˆ·æ–°token
            async refreshTokenIfNeeded() {
                if (!this.refreshToken || this.isRefreshing) {
                    return false;
                }

                this.isRefreshing = true;
                
                try {
                    const response = await fetch(`${OAUTH_CONFIG.authServer}/api/oauth2/token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            grant_type: 'refresh_token',
                            refresh_token: this.refreshToken,
                            client_id: OAUTH_CONFIG.clientId,
                            client_secret: OAUTH_CONFIG.clientSecret,
                        })
                    });

                    if (response.ok) {
                        const tokenData = await response.json();
                        this.updateTokens(tokenData);
                        return true;
                    } else {
                        throw new Error('Token refresh failed');
                    }
                } catch (error) {
                    console.error('åˆ·æ–°tokenå¤±è´¥:', error);
                    this.clearTokens();
                    return false;
                } finally {
                    this.isRefreshing = false;
                }
            }

            // æ›´æ–°tokenä¿¡æ¯
            updateTokens(tokenData) {
                this.accessToken = tokenData.access_token;
                this.refreshToken = tokenData.refresh_token;
                this.tokenExpiresAt = Date.now() + (tokenData.expires_in * 1000);

                localStorage.setItem('oauth_access_token', this.accessToken);
                localStorage.setItem('oauth_refresh_token', this.refreshToken);
                localStorage.setItem('oauth_token_expires_at', this.tokenExpiresAt.toString());
            }

            oneClickLogin() {
                const state = this.generateState();
                localStorage.setItem('oauth_state', state);

                const authUrl = `${OAUTH_CONFIG.authServer}/api/oauth2/authorize?` +
                    `client_id=${OAUTH_CONFIG.clientId}&` +
                    `redirect_uri=${encodeURIComponent(OAUTH_CONFIG.redirectUri)}&` +
                    `response_type=code&` +
                    `scope=${encodeURIComponent(OAUTH_CONFIG.scope)}&` +
                    `state=${state}&` +
                    `auto_authorize=true`; // å¯ç”¨è‡ªåŠ¨æˆæƒï¼Œå®ç°çœŸæ­£çš„ä¸€é”®ç™»å½•

                // åœ¨å¼¹çª—ä¸­æ‰“å¼€æˆæƒé¡µé¢
                const popup = window.open(authUrl, 'oauth_login', 'width=500,height=600,scrollbars=yes');

                // ç›‘å¬å¼¹çª—å…³é—­
                const checkClosed = setInterval(() => {
                    if (popup.closed) {
                        clearInterval(checkClosed);
                        // æ£€æŸ¥æ˜¯å¦è·å¾—äº†æˆæƒ
                        setTimeout(() => this.init(), 1000);
                    }
                }, 1000);
            }

            async handleAuthCallback(code, state) {
                const savedState = localStorage.getItem('oauth_state');
                if (state !== savedState) {
                    console.error('Stateå‚æ•°ä¸åŒ¹é…');
                    return;
                }

                try {
                    const response = await fetch(`${OAUTH_CONFIG.authServer}/api/oauth2/token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            grant_type: 'authorization_code',
                            code: code,
                            client_id: OAUTH_CONFIG.clientId,
                            client_secret: OAUTH_CONFIG.clientSecret,
                            redirect_uri: OAUTH_CONFIG.redirectUri
                        })
                    });

                    const tokenData = await response.json();
                    
                    if (tokenData.access_token) {
                        this.updateTokens(tokenData);
                        localStorage.removeItem('oauth_state');
                        
                        await this.fetchUserInfo();
                        this.showUserInfo();
                    }
                } catch (error) {
                    console.error('è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥:', error);
                }
            }

            // å¸¦è‡ªåŠ¨åˆ·æ–°çš„APIè¯·æ±‚æ–¹æ³•
            async apiRequest(url, options = {}) {
                // æ£€æŸ¥å¹¶åˆ·æ–°token
                if (this.isTokenExpired()) {
                    const refreshed = await this.refreshTokenIfNeeded();
                    if (!refreshed) {
                        throw new Error('Unable to refresh token');
                    }
                }

                const headers = {
                    'Authorization': `Bearer ${this.accessToken}`,
                    ...options.headers
                };

                const response = await fetch(url, {
                    ...options,
                    headers
                });

                // å¦‚æœæ”¶åˆ°401é”™è¯¯ï¼Œå°è¯•åˆ·æ–°tokenå¹¶é‡è¯•ä¸€æ¬¡
                if (response.status === 401 && !options._retry) {
                    const refreshed = await this.refreshTokenIfNeeded();
                    if (refreshed) {
                        return this.apiRequest(url, { ...options, _retry: true });
                    }
                }

                return response;
            }

            async fetchUserInfo() {
                const response = await this.apiRequest(`${OAUTH_CONFIG.authServer}/api/oauth2/userinfo`);

                if (!response.ok) {
                    throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }

                this.userInfo = await response.json();
            }

            showUserInfo() {
                document.getElementById('username').textContent = this.userInfo.username;
                document.getElementById('email').textContent = this.userInfo.email;
                document.getElementById('balance').textContent = this.userInfo.balance_formatted;

                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('login-section').classList.add('hidden');
            }

            showLoginSection() {
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('login-section').classList.remove('hidden');
            }

            async refreshBalance() {
                try {
                    await this.fetchUserInfo();
                    document.getElementById('balance').textContent = this.userInfo.balance_formatted;
                    alert('ä½™é¢å·²æ›´æ–°');
                } catch (error) {
                    alert('åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                    this.clearTokens();
                    this.showLoginSection();
                }
            }

            async goToTopup() {
                try {
                    const response = await this.apiRequest(`${OAUTH_CONFIG.authServer}/api/oauth2/topup`);

                    const data = await response.json();
                    if (data.topup_url) {
                        window.open(data.topup_url, '_blank');
                    }
                } catch (error) {
                    console.error('è·å–å……å€¼é“¾æ¥å¤±è´¥:', error);
                }
            }

            logout() {
                this.clearTokens();
                this.showLoginSection();
            }

            clearTokens() {
                this.accessToken = null;
                this.refreshToken = null;
                this.tokenExpiresAt = null;
                this.userInfo = null;
                
                localStorage.removeItem('oauth_access_token');
                localStorage.removeItem('oauth_refresh_token');
                localStorage.removeItem('oauth_token_expires_at');
            }

            generateState() {
                return Math.random().toString(36).substring(2, 15) + 
                       Math.random().toString(36).substring(2, 15);
            }
        }

        // å…¨å±€å‡½æ•°
        let oauthManager;

        function oneClickLogin() {
            oauthManager.oneClickLogin();
        }

        function refreshBalance() {
            oauthManager.refreshBalance();
        }

        function goToTopup() {
            oauthManager.goToTopup();
        }

        function logout() {
            oauthManager.logout();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            oauthManager = new OAuthManager();
        });
    </script>
</body>
</html>
```

### OAuth å›è°ƒé¡µé¢

åˆ›å»º `/oauth/callback.html` æ–‡ä»¶ï¼š

```html
<!DOCTYPE html>
<html>
<head>
    <title>ç™»å½•å¤„ç†ä¸­...</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        .loading { color: #666; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h2>ç™»å½•å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</h2>
    <div id="status" class="loading">æ­£åœ¨éªŒè¯æˆæƒä¿¡æ¯...</div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');

        if (error) {
            document.getElementById('status').innerHTML = 
                `<div class="error">æˆæƒå¤±è´¥: ${error}</div>`;
            setTimeout(() => {
                if (window.opener) {
                    window.close();
                } else {
                    window.location.href = '/';
                }
            }, 3000);
        } else if (code) {
            if (window.opener) {
                // å¦‚æœæ˜¯å¼¹çª—ï¼Œå…³é—­å¹¶è®©çˆ¶çª—å£å¤„ç†
                window.opener.location.href = 
                    window.opener.location.pathname + `?code=${code}&state=${state}`;
                window.close();
            } else {
                // å¦‚æœä¸æ˜¯å¼¹çª—ï¼Œé‡å®šå‘åˆ°ä¸»é¡µé¢
                window.location.href = `/?code=${code}&state=${state}`;
            }
        } else {
            document.getElementById('status').innerHTML = 
                '<div class="error">æœªæ”¶åˆ°æœ‰æ•ˆçš„æˆæƒä¿¡æ¯</div>';
            setTimeout(() => {
                window.location.href = '/';
            }, 3000);
        }
    </script>
</body>
</html>
```

### Node.js åç«¯ç¤ºä¾‹

ä¸ºäº†æ›´å¥½çš„å®‰å…¨æ€§ï¼Œå»ºè®®åœ¨åç«¯å¤„ç† `client_secret`ï¼š

```js
const express = require('express');
const cors = require('cors');
const fetch = require('node-fetch');

const app = express();
app.use(cors());
app.use(express.json());

const OAUTH_CONFIG = {
    authServer: 'https://your-domain.com',
    clientId: 'YOUR_CLIENT_ID',
    clientSecret: 'YOUR_CLIENT_SECRET'
};

// åç«¯å¤„ç†tokenäº¤æ¢
app.post('/api/oauth/exchange-token', async (req, res) => {
    const { code, redirectUri, state } = req.body;

    try {
        const response = await fetch(`${OAUTH_CONFIG.authServer}/api/oauth2/token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                client_id: OAUTH_CONFIG.clientId,
                client_secret: OAUTH_CONFIG.clientSecret,
                redirect_uri: redirectUri
            })
        });

        const tokenData = await response.json();
        
        if (response.ok) {
            res.json(tokenData);
        } else {
            res.status(400).json(tokenData);
        }
    } catch (error) {
        res.status(500).json({ error: 'Token exchange failed' });
    }
});

// åˆ·æ–°tokenç«¯ç‚¹
app.post('/api/oauth/refresh-token', async (req, res) => {
    const { refreshToken } = req.body;

    if (!refreshToken) {
        return res.status(400).json({ error: 'Missing refresh token' });
    }

    try {
        const response = await fetch(`${OAUTH_CONFIG.authServer}/api/oauth2/token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                grant_type: 'refresh_token',
                refresh_token: refreshToken,
                client_id: OAUTH_CONFIG.clientId,
                client_secret: OAUTH_CONFIG.clientSecret,
            })
        });

        const tokenData = await response.json();
        
        if (response.ok) {
            res.json(tokenData);
        } else {
            res.status(400).json(tokenData);
        }
    } catch (error) {
        res.status(500).json({ error: 'Token refresh failed' });
    }
});

// ä»£ç†ç”¨æˆ·ä¿¡æ¯è¯·æ±‚ï¼ˆå¸¦è‡ªåŠ¨åˆ·æ–°ï¼‰
app.get('/api/oauth/userinfo', async (req, res) => {
    const authHeader = req.headers.authorization;
    
    if (!authHeader) {
        return res.status(401).json({ error: 'Missing authorization header' });
    }

    try {
        const response = await fetch(`${OAUTH_CONFIG.authServer}/api/oauth2/userinfo`, {
            headers: {
                'Authorization': authHeader
            }
        });

        const userData = await response.json();
        
        if (response.ok) {
            res.json(userData);
        } else {
            res.status(response.status).json(userData);
        }
    } catch (error) {
        res.status(500).json({ error: 'Failed to fetch user info' });
    }
});

app.listen(3000, () => {
    console.log('Server running on port 3000');
});
```

## å®‰å…¨æœ€ä½³å®è·µ

### 1. å®¢æˆ·ç«¯å¯†é’¥ä¿æŠ¤

- âœ… æ¨èï¼šå°† `client_secret` å­˜å‚¨åœ¨åç«¯æœåŠ¡å™¨
- âŒ é¿å…ï¼šåœ¨å‰ç«¯JavaScriptä¸­æš´éœ² `client_secret`

### 2. State å‚æ•°éªŒè¯

```js
// ç”Ÿæˆéšæœºstate
const state = crypto.randomBytes(16).toString('hex');
localStorage.setItem('oauth_state', state);

// éªŒè¯state
const savedState = localStorage.getItem('oauth_state');
if (receivedState !== savedState) {
    throw new Error('CSRF attack detected');
}
```

### 3. HTTPS ä½¿ç”¨

- ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ `HTTPS`
- å›è°ƒåœ°å€å¿…é¡»ä½¿ç”¨ `HTTPS`
- æ‰€æœ‰ API è¯·æ±‚ä½¿ç”¨ `HTTPS`

### 4. Token å®‰å…¨å­˜å‚¨

```js
// è®¾ç½® token è¿‡æœŸæ—¶é—´
const expiryTime = Date.now() + (tokenData.expires_in * 1000);
localStorage.setItem('oauth_token_expiry', expiryTime);

// æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
function isTokenExpired() {
    const expiry = localStorage.getItem('oauth_token_expiry');
    return !expiry || Date.now() > parseInt(expiry);
}
```

### 5. é”™è¯¯å¤„ç†

```js
try {
    const response = await fetch('/api/oauth2/userinfo', {
        headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!response.ok) {
        if (response.status === 401) {
            // Tokenè¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•
            clearToken();
            showLoginSection();
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    }
    
    const userInfo = await response.json();
    return userInfo;
} catch (error) {
    console.error('API request failed:', error);
    // å¤„ç†ç½‘ç»œé”™è¯¯ç­‰
}
```

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•å®ç°çœŸæ­£çš„ä¸€é”®ç™»å½•ä½“éªŒï¼Ÿ

A: åœ¨æˆæƒURLä¸­æ·»åŠ  `auto_authorize=true` å‚æ•°å³å¯ã€‚è¿™æ ·ç”¨æˆ·ç™»å½•å®Œæˆåä¼šè‡ªåŠ¨å®Œæˆæˆæƒï¼Œæ— éœ€é¢å¤–çš„ç¡®è®¤æ­¥éª¤ï¼š

```js
const authUrl = 'https://your-domain.com/api/oauth2/authorize?' +
  'client_id=YOUR_CLIENT_ID&' +
  'auto_authorize=true&' + // å…³é”®å‚æ•°
  '...å…¶ä»–å‚æ•°';
```

### Q2: Token ä¼šè‡ªåŠ¨åˆ·æ–°å—ï¼Ÿ

A: æ˜¯çš„ï¼Œæˆ‘ä»¬çš„ SDK å†…ç½®äº†è‡ªåŠ¨ token åˆ·æ–°æœºåˆ¶ï¼š

- è®¿é—®ä»¤ç‰Œï¼š2å°æ—¶æœ‰æ•ˆæœŸï¼Œè¿‡æœŸå‰ 5 åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
- åˆ·æ–°ä»¤ç‰Œï¼š30å¤©æœ‰æ•ˆæœŸï¼Œç”¨äºè·å–æ–°çš„è®¿é—®ä»¤ç‰Œ
- æ— æ„Ÿåˆ·æ–°ï¼šæ‰€æœ‰ API è°ƒç”¨éƒ½ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶åˆ·æ–°è¿‡æœŸçš„ token
- å¤±è´¥é‡è¯•ï¼šå¦‚æœ API è¿”å› 401 é”™è¯¯ï¼Œä¼šè‡ªåŠ¨å°è¯•åˆ·æ–° token å¹¶é‡è¯•

```js
// SDK ä¼šè‡ªåŠ¨å¤„ç† token åˆ·æ–°ï¼Œæ‚¨æ— éœ€æ‰‹åŠ¨å¤„ç†
const userInfo = await oauthManager.fetchUserInfo(); // è‡ªåŠ¨åˆ·æ–°token
```

åªæœ‰åœ¨åˆ·æ–°ä»¤ç‰Œä¹Ÿè¿‡æœŸæ—¶ï¼Œæ‰éœ€è¦ç”¨æˆ·é‡æ–°ç™»å½•ã€‚

### Q3: å¯ä»¥è·å–å“ªäº›ç”¨æˆ·ä¿¡æ¯ï¼Ÿ

A: æ ¹æ®æˆæƒ scopeï¼Œæ‚¨å¯ä»¥è·å–ï¼š
- `profile` scope: ç”¨æˆ·åã€é‚®ç®±
- `balance` scope: è´¦æˆ·ä½™é¢ä¿¡æ¯

### Q4: å¦‚ä½•æµ‹è¯• OAuth é›†æˆï¼Ÿ

A: 
1. åœ¨å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨ `HTTP localhost` è¿›è¡Œæµ‹è¯•
2. ä½¿ç”¨æˆ‘ä»¬æä¾›çš„æµ‹è¯•å·¥å…·éªŒè¯æˆæƒæµç¨‹
3. æ£€æŸ¥æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­çš„ç½‘ç»œè¯·æ±‚

### Q5: æ”¯æŒå“ªäº›ç¼–ç¨‹è¯­è¨€ï¼Ÿ

A: æˆ‘ä»¬æä¾›æ ‡å‡†çš„OAuth2 APIï¼Œæ”¯æŒæ‰€æœ‰ä¸»æµç¼–ç¨‹è¯­è¨€ï¼š
- JavaScript/Node.js
- Python
- PHP
- Java
- C#/.NET
- Go
- Ruby

### Q6: å¦‚ä½•æ’¤é”€ç”¨æˆ·æˆæƒï¼Ÿ

A: ç”¨æˆ·å¯ä»¥åœ¨æˆ‘ä»¬çš„ç”¨æˆ·ä¸­å¿ƒ > æˆæƒç®¡ç†é¡µé¢æ’¤é”€å¯¹ç¬¬ä¸‰æ–¹åº”ç”¨çš„æˆæƒã€‚